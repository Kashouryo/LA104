#include <iostream>
#include "library.h"
#include "../../../os_host/source/framework/Classes.h"
#include "../source/protocol/protocol.h"
#include "../source/protocol/oregon2.h"
#include "../source/protocol/weather.h"
#include "../source/protocol/key360.h"
#include "../source/protocol/vw.h"

//uint16_t sig[] = {500, 440, 460, 480, 460, 460, 460, 460, 460, 460, 460, 460, 460, 460, 460, 460, 480, 460, 480, 420, 500, 460, 460, 460, 460, 460, 460, 460, 460, 480, 460, 460, 460, 460, 460, 460, 460, 460, 480, 460, 460, 460, 460, 460, 460, 460, 460, 940, 980, 920, 940, 460, 500, 420, 480, 440, 480, 460, 460, 960, 460, 440, 480, 440, 980, 920, 960, 920, 500, 420, 500, 420, 500, 460, 960, 920, 940, 940, 480, 460, 460, 460, 480, 440, 960, 440, 500, 900, 980, 420, 500, 420, 500, 460, 460, 460, 460, 920, 500, 460, 460, 460, 460, 460, 460, 460, 460, 460, 460, 460, 500, 440, 940, 460, 460, 940, 480, 460, 960, 920, 460, 460, 480, 440, 480, 460, 460, 460, 460, 460, 460, 460, 960, 920, 500, 420, 500, 460, 460, 460, 940, 940, 480, 420, 500, 440, 480, 420, 500, 460, 460, 460, 960, 920, 460, 460, 500, 420, 480, 460, 960, 920, 500, 420, 500, 420, 480, 480, 940, 920, 500, 420, 500};
//uint16_t sig[] = {440, 8820, 440, 1940, 420, 1960, 420, 3980, 440, 3980, 440, 1940, 440, 3960, 460, 3960, 460, 3960, 480, 1920, 420, 1940, 460, 3960, 440, 1940, 420, 1940, 460, 3940, 480, 1940, 420, 1920, 440, 4000, 420, 4000, 440, 3980, 440, 3960, 460, 1920, 440, 1940, 420, 1960, 420, 1920, 460, 3980, 440, 3980, 460, 3940, 480, 3940, 480, 3940, 480, 3940, 480, 3940, 480, 3940, 480, 3960, 460, 1920, 440, 3980, 440, 4100, 440, 8780, 460, 1940, 420, 1960, 420, 3980, 420, 4020, 440, 1940, 420, 3980, 440, 3980, 460, 3960, 460, 1900, 440, 1940, 420, 3980, 460, 1940, 440, 1940, 420, 4000, 420, 1940, 420, 1940, 440, 3980, 460, 3960, 460, 3960, 460, 3960, 460, 1920, 420, 1940, 440, 1940, 440, 1920, 460, 3980, 420, 4000, 420, 3980, 440, 3980, 440, 3980, 440, 4000, 440, 3980, 420, 4000, 420, 4000, 420, 1960, 440, 3980, 440, 4100, 440, 8800, 440, 1920, 440, 1940, 440, 3960, 440, 3980, 440, 1940, 420, 4000, 440, 3980, 460, 3960, 460, 1900, 480, 1900, 440, 3980, 460, 1940, 420, 1960, 400, 3980, 460, 1920, 420, 1960, 440, 3960, 480, 3960, 420, 4000, 420, 4000, 440, 1940, 440, 1940, 420, 1940, 440, 1940, 420, 3980, 440, 3980, 440, 4000, 440, 3960, 440, 4000, 420, 4000, 440, 3980, 420, 4000, 420, 3980, 440, 1960, 420, 3980, 420, 4140, 440, 8780, 440, 1940, 420, 1940, 420, 4020, 440, 3980, 440, 1920, 440, 3980, 440, 3980, 460, 3960, 460, 1920, 420, 1940, 440, 3980, 440, 1920, 440, 1940, 420, 4000, 440, 1940, 420, 1960, 440, 3960, 460, 3960, 460, 3980, 440, 3960, 460, 1920, 440, 1940, 440, 1940, 420, 1940, 440, 4000, 420, 3980, 420, 4000, 440, 3980, 460, 3960, 440, 4000, 420, 3980, 440, 3980, 440, 3980, 440, 1940, 440, 3980, 460, };
//uint16_t sig[] = {360, 440, 240, 440, 280, 460, 280, 420, 280, 440, 320, 380, 320, 420, 300, 420, 300, 420, 300, 420, 300, 400, 320, 3800, 700, 400, 700, 400, 720, 400, 700, 380, 700, 400, 700, 380, 720, 400, 700, 380, 720, 380, 740, 380, 700, 380, 720, 400, 300, 780, 740, 360, 720, 400, 320, 760, 340, 760, 720, 380, 320, 780, 340, 740, 340, 760, 340, 780, 320, 760, 340, 760, 720, 360, 740, 380, 340, 760, 720, 380, 720, 380, 700, 420, 700, 360, 720, 380, 740, 360, 360, 740, 340, 780, 320, 760, 340, 780, 700, 380, 340, 740, 380, 740, 340, 740, 740, 380, 340, 760, 360, 740, 340, 740, 340, 760, 340, 760, 720, 400, 320, 760, 720, 380, 720, 400, 340, 740, 340, 760, 340, 740, 340, 780, 720, 360, 360, 740, 720, 400, 340, 760, 700, 400, 320, 760, 740, 360, 720, 360, 360, 760, 340, };
/*
uint16_t sig[1024];
const char* psig = "222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222"
"423333332"
"22422222222222222222222422224222222224224444222242242222224224422442222222242222222244222222224444222244224222244222222224222244";
*/
//uint16_t sig[] = {500, 460, 500, 460, 480, 440, 520, 460, 480, 440, 520, 440, 500, 440, 500, 440, 480, 480, 500, 440, 500, 440, 520, 440, 500, 480, 440, 480, 460, 480, 480, 460, 500, 440, 520, 440, 500, 440, 500, 460, 460, 480, 480, 460, 480, 500, 440, 520, 440, 500, 440, 500, 440, 480, 480, 500, 440, 480, 480, 460, 500, 460, 500, 440, 480, 460, 480, 480, 460, 480, 480, 460, 480, 480, 500, 440, 500, 440, 480, 480, 500, 440, 500, 440, 520, 440, 500, 440, 500, 440, 520, 440, 500, 440, 500, 460, 460, 480, 480, 460, 480, 480, 460, 480, 480, 460, 480, 480, 460, 480, 480, 460, 480, 480, 460, 480, 500, 440, 520, 440, 500, 440, 500, 440, 520, 440, 480, 460, 500, 460, 500, 440, 500, 440, 480, 480, 500, 440, 500, 440, 520, 440, 480, 460, 480, 460, 480, 480, 480, 460, 500, 460, 460, 480, 500, 440, 480, 480, 460, 480, 500, 440, 520, 440, 500, 440, 500, 440, 480, 480, 460, 480, 480, 480, 460, 480, 480, 460, 480, 480, 460, 480, 480, 460, 480, 500, 440, 500, 460, 500, 440, 500, 440, 520, 440, 460, 480, 500, 440, 480, 480, 460, 480, 480, 500, 440, 480, 460, 480, 480, 460, 520, 460, 460, 500, 440, 480, 460, 480, 480, 500, 440, 480, 500, 440, 500, 440, 500, 460, 500, 440, 500, 440, 480, 480, 480, 460, 480, 500, 440, 480, 480, 500, 440, 500, 440, 500, 460, 500, 440, 500, 440, 980, 460, 760, 680, 760, 700, 740, 700, 500, 440, 500, 940, 480, 460, 480, 480, 460, 480, 500, 440, 480, 480, 960, 960, 520, 440, 460, 480, 960, 980, 500, 440, 480, 480, 460, 480, 960, 480, 500, 440, 480, 480, 460, 980, 960, 480, 460, 980, };
uint16_t sig[] = {480, 500, 460, 520, 420, 500, 440, 520, 440, 500, 440, 520, 440, 500, 440, 500, 440, 520, 440, 500, 440, 500, 440, 520, 440, 500, 440, 500, 460, 460, 480, 480, 460, 480, 500, 440, 480, 480, 460, 480, 500, 440, 480, 480, 460, 480, 500, 440, 480, 480, 500, 440, 480, 480, 460, 480, 460, 480, 500, 460, 460, 480, 480, 460, 480, 480, 500, 440, 480, 460, 500, 460, 460, 480, 500, 440, 520, 440, 460, 480, 500, 440, 480, 480, 460, 480, 500, 440, 520, 440, 480, 460, 480, 480, 500, 440, 480, 460, 500, 460, 500, 440, 480, 460, 480, 480, 500, 440, 500, 440, 520, 440, 500, 440, 500, 440, 480, 480, 500, 440, 480, 460, 520, 440, 480, 460, 500, 460, 460, 480, 500, 440, 480, 480, 460, 480, 500, 440, 520, 440, 500, 440, 480, 480, 460, 480, 500, 440, 500, 440, 520, 440, 500, 440, 500, 460, 500, 440, 500, 440, 520, 440, 500, 440, 500, 440, 500, 460, 500, 440, 500, 440, 520, 440, 500, 440, 500, 440, 520, 440, 500, 440, 500, 460, 500, 440, 480, 460, 500, 460, 500, 440, 500, 440, 520, 440, 500, 440, 500, 440, 520, 440, 500, 440, 500, 460, 500, 440, 500, 440, 500, 460, 500, 440, 500, 440, 500, 460, 500, 440, 500, 440, 520, 440, 500, 440, 500, 440, 520, 440, 500, 440, 500, 440, 520, 440, 500, 440, 500, 440, 520, 440, 500, 440, 500, 460, 500, 440, 500, 440, 500, 460, 1000, 440, 740, 700, 740, 700, 740, 700, 500, 440, 500, 940, 500, 460, 500, 440, 500, 440, 520, 440, 460, 480, 500, 440, 1000, 940, 500, 460, 500, 440, 1000, 940, 980, 940, 480, 480, 1000, 440, 500, 940, 500, 440, 500, 440, 520, 440, 1000, 940, 980, 440, 520, 920, 520, 440, 1000, 440, 500, 440, 500, 940, 1000, 940, 480, 460, 520, 440, 500, 440, 1000, 440, 500, 940, 480, 480, 500, 440, 500, 440, 1000, 440, 500, 940, 1000, 940, 1000, 440, 500, 940, 500, 440, 520, 440, 1000, 440, 500, 440, 500, 440, 520, 440, 500, 440, 500, 460, 500, 940, 500, 440, 500, 440, 520, 440, 1000, 440, 500, 440, 500, 440, 520, 440, 500, 440, 500, 940, 500, 440, 520, 440, 1000, 440, 500, 440, 500, };
/*
    void AnalyseBuffer(CArray<uint16_t>& pulse)
    {
        static int nRecordId = 1000;
        
        if (weather.Demodulate(pulse, attributes))
        {
            //weather.Example(attributes);
            attributes["timestamp"] = BIOS::SYS::GetTick();
            attributes["uid"] = nRecordId++;
            appData.AddCaptureRecord(&weather, attributes);
            appData.GetWaveform(appData.GetCaptureRecords()-1, mDetails.GetWave());
            return;
        }
        if (oregon.Demodulate(pulse, attributes))
        {
            //weather.Example(attributes);
            attributes["timestamp"] = BIOS::SYS::GetTick();
            attributes["uid"] = nRecordId++;
            appData.AddCaptureRecord(&oregon, attributes);
            appData.GetWaveform(appData.GetCaptureRecords()-1, mDetails.GetWave());
            return;
        }
    }
*/

int main()
{
  CAttributes::TAttribute attributesData[20];
  CAttributes attributes(attributesData, COUNT(attributesData));
  attributes["haha"] = 33;

  CArray<uint16_t> pulse(sig, COUNT(sig));
  pulse.SetSize(COUNT(sig));


//  CArray<uint16_t> pulse(sig, COUNT(sig));
//  for (int i=0; i<strlen(psig); i++)
//    pulse.Add((psig[i] - '0')*360);

  COregon2 oregon2;
  CWeather weather;
  CKey360 key360;
  CVw vw;
  
  if (vw.Demodulate(pulse, attributes))
  {
    std::cout << "OK\n";
    for (int i=0; i<attributes.GetSize(); i++)
    {
      std::cout << attributes[i].key << " = " << std::hex << attributes[i].value << "\n";
//af82
    }
    uint16_t reverseData[1024];
    CArray<uint16_t> reverse(reverseData, COUNT(reverseData));

    key360.Modulate(attributes, reverse);

  } else
  {
    std::cout << "FAILED\n";
  }

  return 0;
}
